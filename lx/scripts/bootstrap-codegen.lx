// Generic bootstrap codegen script
// Usage: lx run scripts/bootstrap-codegen.lx <entry-file>
// Example: lx run scripts/bootstrap-codegen.lx lx/main.lx
// Output: /tmp/main.lxobj

let common = import "commands/common.lx"

// Get entry file from command line args
// Lx.args: [lx, run, script, arg1, ...]
if len(Lx.args) < 4 {
  Lx.stderr.println("Usage: lx run scripts/bootstrap-codegen.lx <entry-file>")
  Lx.stderr.println("Example: lx run scripts/bootstrap-codegen.lx lx/main.lx")
  Lx.exit(1)
}

let entryFile = Lx.args[3]
println("=== Building " + entryFile + " with NEW codegen (PR3) ===")
println("")

// Compile with proper error reporting
println("=== Compiling " + entryFile + " and all dependencies ===")
let mainFunction = common.compilePathToFunction(entryFile, nil)
if !mainFunction {
  Lx.stderr.println("Compilation failed - see errors above")
  Lx.exit(65)
}

println("Codegen successful")
println("")

// Build object
println("=== Building Object ===")
let hexBytes = common.objbuilder(mainFunction, false).bytes()
println("Object size: " + str(len(hexBytes)) + " bytes")

// Output to /tmp/{basename}.lxobj
let filename = Lx.path.basename(entryFile)

// Strip extension from filename
let basename = ""
for let i = 0; i < len(filename); i = i + 1 {
  if filename[i] == "." {
    break
  }
  basename = basename + filename[i]
}

let outputPath = "/tmp/" + basename + ".lxobj"
let byteString = common.bytesToString(hexBytes)
let ok = Lx.fs.writeFile(outputPath, byteString)
if ok != true {
  Lx.stderr.println(ok or "Failed to write output.")
  Lx.exit(74)
}

println("Saved to " + outputPath)
println("")
println("SUCCESS: " + entryFile + " bytecode built with NEW codegen")
