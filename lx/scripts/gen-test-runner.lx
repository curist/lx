// Generate test runner that imports all test files
// This allows running all tests in a single process, sharing compiled modules

// Find all test files in test/
let testDir = "test"
let result = exec("ls " + testDir + "/*.test.lx")
let testFiles = if result.code == 0 {
  result.out
    ->lines()
    ->filter(fn(line) { line != "" })
    ->map(fn(fullPath) {
      // Extract just the filename from full path
      let parts = split(fullPath, "/")
      last(parts)
    })
} else {
  []
}

// Generate import statements with filename printing
let imports = testFiles
  ->map(fn(name) {
    "println(\"test/" + name + "\")\nimport \"test/" + name + "\""
  })
  ->join("\n")

let content = "// Generated by scripts/gen-test-runner.lx - do not edit by hand
//
// This file imports all test files in a single process, which allows:
// - Shared compilation of common modules (types, parser, etc.)
// - Single runtime startup cost
// - Module caching across all tests
//
// Test files execute automatically on import via suite.run()

" + imports + "
"

// Write to ../out/run-all-tests.lx
spit("../out/run-all-tests.lx", content)

println("Generated out/run-all-tests.lx with", len(testFiles), "test files")
